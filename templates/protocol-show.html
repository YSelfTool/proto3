{% extends "layout.html" %}
{% from "macros.html" import render_table, render_form %}
{% block title %}Protokoll{% endblock %}

{% set loggedin = check_login() %}
{% set user = current_user() %}
{% set has_public_view_right = protocol.protocoltype.has_public_view_right(user) %}
{% set has_private_view_right = protocol.protocoltype.has_private_view_right(user) %}
{% set has_modify_right = protocol.protocoltype.has_modify_right(user) %}

{% block content %}
<div class="container">
    <div class="btn-group">
        {% if has_modify_right %}
            <a class="btn {% if protocol.source is none %}btn-primary{% else %}btn-default{% endif %}" href="{{url_for("etherpull_protocol", protocol_id=protocol.id)}}">Aus Etherpad</a>
            {% if protocol.source is not none %}
                <a class="btn btn-primary" href="{{url_for("get_protocol_source", protocol_id=protocol.id)}}">Download Quelltext</a>
            {% endif %} 
            <a class="btn {% if protocol.is_done() %}btn-success{% else %}btn-default{% endif %}" href="{{url_for("update_protocol", protocol_id=protocol.id)}}">Protokoll editieren</a>
            {% if not protocol.is_done() %}
                <a class="btn btn-default" href="{{url_for("get_protocol_template", protocol_id=protocol.id)}}">Vorlage</a>
                <a class="btn btn-primary" href="{{url_for("etherpush_protocol", protocol_id=protocol.id)}}">In Etherpad</a>
            {% else %}
                <a class="btn btn-default" href="{{url_for("send_protocol", protocol_id=protocol.id)}}">Per Mail versenden</a>
            {% endif %}
            <a class="btn btn-default" href="{{protocol.get_etherpad_link()}}" target="_blank">Etherpad</a>
            <a class="btn btn-default" href="{{url_for("show_type", type_id=protocol.protocoltype.id)}}">Typ</a>
            <a class="btn btn-danger" href="{{url_for("delete_protocol", protocol_id=protocol.id)}}" onclick="return confirm('Bist du dir sicher, dass du das Protokoll {{protocol.get_identifier()}} löschen möchtest?');">Löschen</a>
        {% endif %}
    </div>
    <div class="row">
        <div id="left-column" class="col-lg-6">
            <h2>Protokoll: {{protocol.protocoltype.name}} {% if protocol.date is not none %}vom {{protocol.date|datify}}{% endif %}</h2>
            {% if protocol.is_done() %}
                {% if protocol.date is not none %}
                    <p><strong>Datum:</strong> {{protocol.date|datify_long}}</p>
                {% endif %}
                {% if protocol.start_time is not none and protocol.end_time is not none %}
                    <p><strong>Zeit:</strong> von {{protocol.start_time|timify}} bis {{protocol.end_time|timify}}</p>
                {% endif %}
                {% if protocol.location is not none %}
                    <p><strong>Ort:</strong> {{protocol.location}}</p>
                {% endif %}
                {% if protocol.author is not none %}
                    <p><strong>Protokollant:</strong> {{protocol.author}}</p>
                {% endif %}
                {% if protocol.participants is not none %}
                    <p><strong>Anwesende:</strong> {{protocol.participants}}</p>
                {% endif %}
            {% else %}
                {% if protocol.date is not none %}<p><strong>Geplant:</strong> {{protocol.date|datify_long}}{% endif %}</p>
            {% endif %}

            <h3>Tagesordnung{% if has_modify_right and not protocol.has_nonplanned_tops() %} <a href="{{url_for("new_top", protocol_id=protocol.id)}}">Top hinzufügen</a>{% endif %}</h3>
            {% include "protocol-tops-include.html" %}

            {% if protocol.is_done() %}
            <h3>Beschlüsse</h3>
            <ul>
                {% if protocol.decisions|length > 0 %}
                    {% for decision in protocol.decisions %}
                        <li>{{decision.content}}</li>
                    {% endfor %}
                {% else %}
                    <li>Keine Beschlüsse</li>
                {% endif %}
            </ul>
            {% endif %}
        </div>
        <div id="right-column" class="col-lg-6">
            {% if protocol.is_done() and has_public_view_right and logged_in %}
                <h3>Todos dieser Sitzung <a href="{{url_for("list_todos")}}">Aktuelle Todos</a></h3>
                <ul>
                    {% if protocol.get_originating_todos()|length > 0 %}
                        {% for todo in protocol.get_originating_todos() %}
                            <li>{{todo.render_html()|safe}}</li>
                        {% endfor %}
                    {% else %}
                        <li>Keine Todos</li>
                    {% endif %}
                </ul>
            {% endif %}
            {% if has_modify_right %}
                {% if protocol.errors|length > 0 %}
                    {{render_table(errors_table)}}
                {% endif %}
            {% endif %}
            {% if protocol.documents|length > 0 %}
                {{render_table(documents_table)}}
            {% else %}
                {% if has_modify_right %}
                    <h3>Hochladen</h3>
                {% endif %}
            {% endif %}
            {% if has_modify_right %}
            {{render_form(source_upload_form, action_url=url_for("upload_source_to_known_protocol", protocol_id=protocol.id, next=url_for("show_protocol", protocol_id=protocol.id)), action_text="Hochladen", enctype="multipart/form-data")}}
            {{render_form(document_upload_form, action_url=url_for("upload_document", protocol_id=protocol.id, next=url_for("show_protocol", protocol_id=protocol.id)), action_text="Hochladen", enctype="multipart/form-data")}}
            {% endif %}
        </div>
    </div>
</div>
{% endblock %}
